services:
    # 1. Backend PHP (Laravel)
    app:
        build: .
        container_name: sukaphorn_app
        volumes:
            - '.:/var/www/html'
        env_file: .env
        depends_on:
            - db
        networks:
            - appnet

    # 2. Web Server (Nginx) - Akses Browser Utama
    nginx:
        image: 'nginx:alpine'
        container_name: sukaphorn_nginx
        ports:
            - '8082:80'  # Akses di http://localhost:8082
        volumes:
            - '.:/var/www/html'
            - './docker/nginx/default.conf:/etc/nginx/conf.d/default.conf'
        depends_on:
            - app
        networks:
            - appnet

    # 3. Frontend React (Vite) - Hot Reload
    vite:
        build: .
        container_name: sukaphorn_vite
        working_dir: /var/www/html
        volumes:
            - '.:/var/www/html'
        # PERBAIKAN: Syntax command array yang lebih rapi & pasti jalan
        command: sh -c "npm install && npm run dev -- --host"
        ports:
            - '5173:5173'
        networks:
            - appnet

    # 4. Database MySQL
    db:
        image: 'mysql:8.0'
        container_name: sukaphorn_db
        environment:
           # MYSQL_USER: root
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: panevkejaksaan_prosakip
        ports:
            - '3307:3306'
        volumes:
            # PERBAIKAN: Hapus baris my.cnf jika file-nya tidak ada (sering bikin error)
            # Jika Anda punya file config custom, hilangkan tanda pagar di bawah:
            # - './docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf'
            - 'dbdata:/var/lib/mysql'
        networks:
            - appnet

    # 5. Ngrok - Share ke Internet
    ngrok:
        image: 'ngrok/ngrok:latest'
        container_name: sukaphorn_ngrok
        command: 'http nginx:80' # Meneruskan traffic ke container Nginx
        environment:
            NGROK_AUTHTOKEN: '${NGROK_AUTHTOKEN}'
        ports:
            - '4040:4040' # Dashboard Ngrok
        depends_on:
            - nginx
        networks:
            - appnet

networks:
    appnet:
        driver: bridge

volumes:
    dbdata:
        driver: local